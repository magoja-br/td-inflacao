<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Avançado de Investimentos: IPCA+, Pré-fixado e Fundos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .form-input, .form-select { width: 100%; padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db; background-color: #ffffff; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .form-input:disabled { background-color: #f3f4f6; cursor: not-allowed; }
        .btn { padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-weight: 600; color: white; transition: background-color 0.2s; cursor: pointer; border: none; }
        .btn-primary { background-color: #3b82f6; }
        .btn-primary:hover { background-color: #2563eb; }
        .table-container { max-height: 500px; overflow: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        thead th { background-color: #f9fafb; position: sticky; top: 0; z-index: 10; }
        tbody tr:nth-child(even) { background-color: #f9fafb; }
        /* Toggle Switch Styles */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body class="antialiased text-gray-800 p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Simulador Avançado de Investimentos</h1>
            <p class="text-gray-600 mt-2">Simule Tesouro IPCA+, Fundos de Renda Fixa e Títulos Pré-fixados.</p>
        </header>

        <form id="simuladorForm">
            <div class="mb-6">
                <label class="block text-lg font-semibold mb-3 text-gray-700">1. Tipo de Rentabilidade</label>
                <div class="flex flex-col sm:flex-row gap-4">
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition-all">
                        <input type="radio" name="tipo_investimento" value="indexado_ipca" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                        <span class="ml-3 text-gray-800">Indexado à Inflação (IPCA + Juros)</span>
                    </label>
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition-all">
                        <input type="radio" name="tipo_investimento" value="prefixado" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <span class="ml-3 text-gray-800">Pré-fixado</span>
                    </label>
                </div>
            </div>

            <hr class="my-6">

            <div>
                 <label class="block text-lg font-semibold mb-3 text-gray-700">2. Parâmetros da Simulação</label>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label for="saldo_inicial" class="block text-sm font-medium text-gray-700 mb-1">Saldo inicial (R$)</label>
                        <input type="text" id="saldo_inicial" class="form-input" value="1.000.000,00">
                    </div>
                    <div>
                        <label for="meses" class="block text-sm font-medium text-gray-700 mb-1">Meses de projeção</label>
                        <input type="text" id="meses" class="form-input" value="240">
                    </div>
                    <div id="ipcaRealContainer" class="contents">
                        <div>
                            <label for="ipca" class="block text-sm font-medium text-gray-700 mb-1">Inflação (IPCA) % a.a.</label>
                            <input type="text" id="ipca" class="form-input" value="3,500">
                        </div>
                        <div>
                            <label for="real" class="block text-sm font-medium text-gray-700 mb-1">Juros Reais % a.a.</label>
                            <input type="text" id="real" class="form-input" value="5,500">
                        </div>
                    </div>
                    <div id="prefixadoContainer" class="hidden contents">
                        <div>
                            <label for="taxa_prefixada_aa" class="block text-sm font-medium text-gray-700 mb-1">Taxa Pré-fixada % a.a.</label>
                            <input type="text" id="taxa_prefixada_aa" class="form-input" value="10,000">
                        </div>
                    </div>
                </div>

                <div id="taxaNominalContainer" class="mb-6 p-3 bg-gray-100 rounded-md text-center">
                    <span class="text-sm font-medium text-gray-600">Taxa Nominal Anual (Juros Compostos): </span>
                    <span id="taxaNominalDisplay" class="text-sm font-bold text-gray-800"></span>
                </div>
                 
                 <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="inflacao_zero" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700 font-medium">Calcular com inflação zero (para análise de juros reais)</span>
                    </label>
                 </div>
            </div>
            
            <label class="block text-lg font-semibold mb-3 text-gray-700">3. Taxas e Impostos</label>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                 <div>
                    <label for="tipo_taxa" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Taxa</label>
                    <select id="tipo_taxa" class="form-select">
                        <option value="custodia">Taxa de Custódia (Tesouro Direto)</option>
                        <option value="adm">Taxa de Administração (Fundos)</option>
                    </select>
                 </div>
                 <div id="custodiaContainer">
                    <label for="custodia" class="block text-sm font-medium text-gray-700 mb-1">Taxa de Custódia % a.a.</label>
                    <input type="text" id="custodia" class="form-input" value="0,200">
                </div>
                 <div id="admContainer" class="hidden">
                    <label for="taxa_adm_aa" class="block text-sm font-medium text-gray-700 mb-1">Taxa de Administração % a.a.</label>
                    <input type="text" id="taxa_adm_aa" class="form-input" value="1,000">
                </div>
                 <div>
                    <label for="ir_modo" class="block text-sm font-medium text-gray-700 mb-1">Imposto de Renda</label>
                    <select id="ir_modo" class="form-select">
                        <option value="regressiva">Tabela Regressiva</option>
                        <option value="comecotas">Come-Cotas (Fundos)</option>
                        <option value="fixa">Alíquota Fixa</option>
                    </select>
                </div>
                <div id="tipoFundoContainer" class="hidden">
                    <label for="tipo_fundo" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Fundo (Come-Cotas)</label>
                    <select id="tipo_fundo" class="form-select">
                        <option value="longo">Longo Prazo (Alíquota 15%)</option>
                        <option value="curto">Curto Prazo (Alíquota 20%)</option>
                    </select>
                </div>
                <div id="aliquota_fixa_container" class="hidden">
                    <label for="aliquota_fixa" class="block text-sm font-medium text-gray-700 mb-1">Alíquota Fixa (%)</label>
                    <input type="text" id="aliquota_fixa" class="form-input" value="15,000">
                </div>
            </div>
            
            <hr class="my-6">

            <div>
                <label class="block text-lg font-semibold mb-3 text-gray-700">4. Movimentações Mensais</label>
                <div class="mb-6 flex flex-col sm:flex-row gap-4">
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition-all">
                        <input type="radio" name="modo_movimentacao" value="nenhum" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                        <span class="ml-3 text-gray-800">Sem Movimentação</span>
                    </label>
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition-all">
                        <input type="radio" name="modo_movimentacao" value="saques" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <span class="ml-3 text-gray-800">Saques Mensais</span>
                    </label>
                     <label class="flex items-center p-4 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition-all">
                        <input type="radio" name="modo_movimentacao" value="aportes" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <span class="ml-3 text-gray-800">Aportes Mensais</span>
                    </label>
                </div>

                <div id="movimentacaoContainer" class="hidden">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div id="saqueInputContainer">
                            <label for="saque_inicial" class="block text-sm font-medium text-gray-700 mb-1">Saque mensal inicial (R$)</label>
                            <input type="text" id="saque_inicial" class="form-input" value="6.000,00">
                        </div>
                        <div id="aporteInputContainer" class="hidden">
                            <label for="aporte_mensal" class="block text-sm font-medium text-gray-700 mb-1">Aporte mensal (R$)</label>
                            <input type="text" id="aporte_mensal" class="form-input" value="1.000,00">
                        </div>
                        <div class="col-span-1 md:col-span-2 flex flex-col sm:flex-row sm:items-center gap-4 sm:pt-6">
                            <label class="flex items-center">
                                <input type="checkbox" id="primeiro_mov_mes2" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                <span class="ml-2 text-sm text-gray-700">1ª movimentação no mês 2</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="corrigir_mov" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                <span class="ml-2 text-sm text-gray-700">Corrigir pela inflação</span>
                            </label>
                             <label id="pararQuandoAcabarContainer" class="flex items-center">
                                <input type="checkbox" id="parar_quando_acabar" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                <span class="ml-2 text-sm text-gray-700">Parar quando saldo acabar</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" id="executarBtn" class="btn btn-primary w-full text-lg mt-8">
                Executar simulação
            </button>
            <div id="error-message" class="mt-4 text-center text-red-600 font-medium"></div>
        </form>

        <div id="results" class="mt-10 hidden">
            <div id="resumoContainer" class="mb-8"></div>
            
             <div class="my-6 p-4 bg-gray-100 rounded-lg flex flex-col sm:flex-row justify-center items-center gap-4 sm:gap-8">
                <div class="flex items-center gap-3">
                    <span class="font-medium text-gray-700">Ver Valores Nominais</span>
                    <label class="switch">
                        <input type="checkbox" id="viewToggle">
                        <span class="slider"></span>
                    </label>
                    <span class="font-medium text-gray-700">Ver Valores Reais</span>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-8">
                
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-800" id="planilhaTitle">Planilha de Evolução</h3>
                    <div id="planilhaContainer" class="table-container"></div>
                    <button id="downloadCsv" class="btn btn-primary mt-4">Baixar CSV</button>
                </div>

                <div>
                     <h3 class="text-xl font-semibold mb-4 text-gray-800" id="chartTitle">Evolução do Saldo</h3>
                    <div class="p-4 border rounded-lg bg-white">
                        <canvas id="saldoChart" style="min-height: 300px;"></canvas>
                    </div>
                </div>

            </div>
        </div>
    </div>

<script>
    // --- LÓGICA DA UI ---
    const form = document.getElementById('simuladorForm');
    const tipoInvestimentoRadios = document.querySelectorAll('input[name="tipo_investimento"]');
    const modoMovimentacaoRadios = document.querySelectorAll('input[name="modo_movimentacao"]');
    
    const ipcaRealContainer = document.getElementById('ipcaRealContainer');
    const prefixadoContainer = document.getElementById('prefixadoContainer');
    const taxaNominalContainer = document.getElementById('taxaNominalContainer');
    const taxaNominalDisplay = document.getElementById('taxaNominalDisplay');
    const ipcaInput = document.getElementById('ipca');
    const realInput = document.getElementById('real');
    
    const tipoTaxaSelect = document.getElementById('tipo_taxa');
    const custodiaContainer = document.getElementById('custodiaContainer');
    const admContainer = document.getElementById('admContainer');

    const irModoSelect = document.getElementById('ir_modo');
    const tipoFundoContainer = document.getElementById('tipoFundoContainer');
    const aliquotaFixaContainer = document.getElementById('aliquota_fixa_container');
    
    const movimentacaoContainer = document.getElementById('movimentacaoContainer');
    const saqueInputContainer = document.getElementById('saqueInputContainer');
    const aporteInputContainer = document.getElementById('aporteInputContainer');
    const pararQuandoAcabarContainer = document.getElementById('pararQuandoAcabarContainer');

    const inflacaoZeroCheckbox = document.getElementById('inflacao_zero');
    const resultsDiv = document.getElementById('results');
    const downloadBtn = document.getElementById('downloadCsv');
    const viewToggle = document.getElementById('viewToggle');
    
    let chartInstance = null;
    let fullData = [];

    // --- Funções de Toggle da UI ---
    function toggleInvestimento() {
        if (document.querySelector('input[name="tipo_investimento"]:checked').value === 'prefixado') {
            ipcaRealContainer.classList.add('hidden');
            prefixadoContainer.classList.remove('hidden');
            taxaNominalContainer.classList.add('hidden');
            inflacaoZeroCheckbox.parentElement.classList.add('hidden');
        } else {
            ipcaRealContainer.classList.remove('hidden');
            prefixadoContainer.classList.add('hidden');
            taxaNominalContainer.classList.remove('hidden');
            inflacaoZeroCheckbox.parentElement.classList.remove('hidden');
            updateTaxaNominalDisplay();
        }
    }

    function toggleTipoTaxa() {
        if (tipoTaxaSelect.value === 'custodia') {
            custodiaContainer.style.display = 'block';
            admContainer.style.display = 'none';
        } else {
            custodiaContainer.style.display = 'none';
            admContainer.style.display = 'block';
        }
    }

    function toggleIrModo() {
        const modo = irModoSelect.value;
        tipoFundoContainer.style.display = modo === 'comecotas' ? 'block' : 'none';
        aliquotaFixaContainer.style.display = modo === 'fixa' ? 'block' : 'none';
    }

    function toggleMovimentacao() {
        const modo = document.querySelector('input[name="modo_movimentacao"]:checked').value;
        if (modo === 'nenhum') {
            movimentacaoContainer.style.display = 'none';
        } else {
            movimentacaoContainer.style.display = 'block';
            saqueInputContainer.style.display = modo === 'saques' ? 'block' : 'none';
            aporteInputContainer.style.display = modo === 'aportes' ? 'block' : 'none';
            pararQuandoAcabarContainer.style.display = modo === 'saques' ? 'flex' : 'none';
        }
    }
    
    function toggleInflacaoZero() {
        if (inflacaoZeroCheckbox.checked) {
            ipcaInput.value = '0,000';
            ipcaInput.disabled = true;
        } else {
            ipcaInput.disabled = false;
        }
        updateTaxaNominalDisplay();
    }
    
    function updateTaxaNominalDisplay() {
        try {
            const ipca = ptbr_to_float(ipcaInput.value) / 100;
            const real = ptbr_to_float(realInput.value) / 100;
            const nominal = ((1 + ipca) * (1 + real) - 1) * 100;
            taxaNominalDisplay.textContent = nominal.toLocaleString('pt-BR', {minimumFractionDigits: 5, maximumFractionDigits: 5}) + '%';
        } catch (e) {
            taxaNominalDisplay.textContent = 'Inválido';
        }
    }

    // --- Event Listeners ---
    tipoInvestimentoRadios.forEach(radio => radio.addEventListener('change', toggleInvestimento));
    modoMovimentacaoRadios.forEach(radio => radio.addEventListener('change', toggleMovimentacao));
    tipoTaxaSelect.addEventListener('change', toggleTipoTaxa);
    irModoSelect.addEventListener('change', toggleIrModo);
    inflacaoZeroCheckbox.addEventListener('change', toggleInflacaoZero);
    ipcaInput.addEventListener('input', updateTaxaNominalDisplay);
    realInput.addEventListener('input', updateTaxaNominalDisplay);
    viewToggle.addEventListener('change', () => {
        const displayMode = viewToggle.checked ? 'real' : 'nominal';
        displayPlanilha(fullData, getInputs(), displayMode);
        displayChart(fullData, displayMode);
    });

    downloadBtn.addEventListener('click', () => {
        const csvData = convertToCSV(fullData);
        const blob = new Blob([`\uFEFF${csvData}`], { type: 'text/csv;charset=utf-8-sig;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', 'simulacao_investimento.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        document.getElementById('error-message').textContent = '';
        resultsDiv.classList.add('hidden');

        try {
            const inputs = getInputs();
            const [df, resumo] = simular(inputs);
            
            fullData = df;
            displayResumo(resumo);
            
            viewToggle.checked = false;
            displayPlanilha(df, inputs, 'nominal');
            displayChart(df, 'nominal');
            
            resultsDiv.classList.remove('hidden');

        } catch (error) {
            console.error(error);
            document.getElementById('error-message').textContent = `Erro: ${error.message}. Verifique os valores de entrada.`;
        }
    });

    // --- FUNÇÕES DE CÁLCULO ---
    const round2 = (x) => Math.round((x + Number.EPSILON) * 100) / 100;
    const fmt_money = (v) => v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const fmt_pct = (v) => v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '%';

    function ptbr_to_float(txt) {
        if (txt === null || txt === undefined) return 0.0;
        const s = String(txt).trim().replace(/\./g, '').replace(',', '.');
        const val = parseFloat(s);
        if (isNaN(val)) throw new Error(`Valor inválido: "${txt}"`);
        return val;
    }

    const taxa_mensal = (t_anual) => Math.pow(1 + t_anual, 1 / 12) - 1;

    function aliquota_regressiva_por_m(meses) {
        if (meses <= 6) return 0.225;
        if (meses <= 12) return 0.20;
        if (meses <= 24) return 0.175;
        return 0.15;
    }

    // --- FUNÇÃO DE SIMULAÇÃO PRINCIPAL ---
    function simular(params) {
        const { modo_movimentacao, saldo_inicial, meses_float, ipca_aa, primeiro_mov_mes2, corrigir_mov, parar_quando_acabar } = params;
        const { saque_inicial, aporte_mensal } = params;

        let r_m;
        if (params.tipo_investimento === 'prefixado') {
            r_m = taxa_mensal(params.taxa_prefixada_aa);
        } else {
            r_m = taxa_mensal((1 + ipca_aa) * (1 + params.real_aa) - 1);
        }

        const ipca_m = taxa_mensal(ipca_aa);
        const taxa_m = params.tipo_taxa === 'custodia' ? taxa_mensal(params.custodia_aa) : taxa_mensal(params.taxa_adm_aa);
        
        let A_Nominal = saldo_inicial;
        let custo_proporcional_total = saldo_inicial;
        let linhas = [];
        let totais = { ir_saque: 0, ir_cc: 0, taxa: 0, saques: 0, aportes: 0 };
        let fator_inflacao_acumulada = 1.0;
        let rendimento_acum_cc = 0.0;

        for (let m = 1; m <= meses_float; m++) {
            const fator_inflacao_anterior = fator_inflacao_acumulada;
            fator_inflacao_acumulada *= (1 + ipca_m);

            const B_Rendimento_Nominal = A_Nominal * r_m;
            const C_Apos_Rend_Nominal = A_Nominal + B_Rendimento_Nominal;
            const D_Taxa_Nominal = C_Apos_Rend_Nominal * taxa_m;
            const E_Apos_Taxas_Nominal = C_Apos_Rend_Nominal - D_Taxa_Nominal;
            
            rendimento_acum_cc += (B_Rendimento_Nominal - D_Taxa_Nominal);
            totais.taxa += D_Taxa_Nominal;
            
            let F_IR_Come_Cotas_Nominal = 0.0;
            if (params.ir_modo === 'comecotas') {
                const mes_calendario = (m % 12 === 0) ? 12 : m % 12;
                if (mes_calendario === 5 || mes_calendario === 11) {
                    if (rendimento_acum_cc > 0) {
                        const aliquota_cc = params.tipo_fundo === 'longo' ? 0.15 : 0.20;
                        F_IR_Come_Cotas_Nominal = rendimento_acum_cc * aliquota_cc;
                        totais.ir_cc += F_IR_Come_Cotas_Nominal;
                        rendimento_acum_cc = 0;
                    }
                }
            }
            
            const G_Apos_CC_Nominal = E_Apos_Taxas_Nominal - F_IR_Come_Cotas_Nominal;
            
            let Saque_Bruto_Nominal = 0.0, IR_Saque_Nominal = 0.0, Aliquota_IR_pct = 0.0;
            let Aporte_Nominal = 0.0;
            
            const deveMovimentar = primeiro_mov_mes2 ? m > 1 : true;
            const fator_correcao = corrigir_mov ? Math.pow(1 + ipca_m, (primeiro_mov_mes2 ? m - 2 : m - 1)) : 1;

            if (modo_movimentacao === 'saques' && deveMovimentar) {
                Saque_Bruto_Nominal = Math.min(saque_inicial * fator_correcao, Math.max(0.0, G_Apos_CC_Nominal));
                
                if (Saque_Bruto_Nominal > 0) {
                    const prop_saque = G_Apos_CC_Nominal > 0 ? (Saque_Bruto_Nominal / G_Apos_CC_Nominal) : 0;
                    const Custo_Proporcional_Saque = custo_proporcional_total * prop_saque;
                    const Rendimento_no_Saque_Nominal = Math.max(0.0, Saque_Bruto_Nominal - Custo_Proporcional_Saque);
                    
                    const aliq_saque = (params.ir_modo === 'regressiva' || params.ir_modo === 'comecotas') ? aliquota_regressiva_por_m(m) : params.aliquota_fixa;
                    Aliquota_IR_pct = aliq_saque * 100.0;
                    IR_Saque_Nominal = Rendimento_no_Saque_Nominal * aliq_saque;
                    totais.ir_saque += IR_Saque_Nominal;

                    custo_proporcional_total -= Custo_Proporcional_Saque;
                }
                totais.saques += Saque_Bruto_Nominal;

            } else if (modo_movimentacao === 'aportes' && deveMovimentar) {
                Aporte_Nominal = aporte_mensal * fator_correcao;
                custo_proporcional_total += Aporte_Nominal;
                totais.aportes += Aporte_Nominal;
            }

            const H_Saldo_Final_Nominal = G_Apos_CC_Nominal - Saque_Bruto_Nominal + Aporte_Nominal;

            linhas.push({
                Mes: m,
                A_Saldo_Inicial_Nominal: A_Nominal, B_Rendimento_Nominal, D_Taxa_Nominal, F_IR_Come_Cotas_Nominal,
                Saque_Bruto_Nominal, Aliquota_IR_pct, IR_Saque_Nominal, Aporte_Nominal, H_Saldo_Final_Nominal,
                A_Saldo_Inicial_Real: A_Nominal / fator_inflacao_anterior,
                B_Rendimento_Real: B_Rendimento_Nominal / fator_inflacao_acumulada,
                D_Taxa_Real: D_Taxa_Nominal / fator_inflacao_acumulada,
                F_IR_Come_Cotas_Real: F_IR_Come_Cotas_Nominal / fator_inflacao_acumulada,
                Saque_Bruto_Real: Saque_Bruto_Nominal / fator_inflacao_acumulada,
                IR_Saque_Real: IR_Saque_Nominal / fator_inflacao_acumulada,
                Aporte_Real: Aporte_Nominal / fator_inflacao_acumulada,
                H_Saldo_Final_Real: H_Saldo_Final_Nominal / fator_inflacao_acumulada
            });
            
            A_Nominal = H_Saldo_Final_Nominal;
            if (parar_quando_acabar && modo_movimentacao === 'saques' && A_Nominal <= 1.0) break;
        }

        let resumo = {
            saldo_final_nominal: A_Nominal,
            saldo_final_real: A_Nominal / fator_inflacao_acumulada,
            total_saques_nominal: totais.saques,
            total_aportes_nominal: totais.aportes,
            total_taxa_nominal: totais.taxa,
            total_ir_saque: totais.ir_saque,
            ir_cc_total: totais.ir_cc,
            periodos_executados: linhas.length
        };
        
        if (modo_movimentacao !== 'saques') {
            const lucro_total_bruto = A_Nominal + totais.taxa - saldo_inicial - totais.aportes;
            const lucro_liquido_taxas = lucro_total_bruto - totais.taxa;
            let ir_final = 0;

            if (params.ir_modo === 'comecotas') {
                const ir_total_devido = (lucro_liquido_taxas) * aliquota_regressiva_por_m(meses_float);
                ir_final = Math.max(0, ir_total_devido - totais.ir_cc);
            } else {
                 const aliq_final = params.ir_modo === 'regressiva' ? aliquota_regressiva_por_m(meses_float) : params.aliquota_fixa;
                 ir_final = lucro_liquido_taxas * aliq_final;
            }

            resumo.ir_final_nominal = ir_final;
            resumo.saldo_liquido_nominal = A_Nominal - ir_final;
            resumo.saldo_liquido_real = resumo.saldo_liquido_nominal / fator_inflacao_acumulada;
        }

        return [linhas, resumo];
    }


    // --- FUNÇÕES DE DISPLAY ---
    function getInputs() {
        const inputs = {
            tipo_investimento: document.querySelector('input[name="tipo_investimento"]:checked').value,
            modo_movimentacao: document.querySelector('input[name="modo_movimentacao"]:checked').value,
            saldo_inicial: ptbr_to_float(document.getElementById('saldo_inicial').value),
            meses_float: ptbr_to_float(document.getElementById('meses').value),
            ipca_aa: ptbr_to_float(document.getElementById('ipca').value) / 100.0,
            real_aa: ptbr_to_float(document.getElementById('real').value) / 100.0,
            taxa_prefixada_aa: ptbr_to_float(document.getElementById('taxa_prefixada_aa').value) / 100.0,
            tipo_taxa: document.getElementById('tipo_taxa').value,
            custodia_aa: ptbr_to_float(document.getElementById('custodia').value) / 100.0,
            taxa_adm_aa: ptbr_to_float(document.getElementById('taxa_adm_aa').value) / 100.0,
            ir_modo: document.getElementById('ir_modo').value,
            tipo_fundo: document.getElementById('tipo_fundo').value,
            aliquota_fixa: ptbr_to_float(document.getElementById('aliquota_fixa').value) / 100.0,
            saque_inicial: ptbr_to_float(document.getElementById('saque_inicial').value),
            aporte_mensal: ptbr_to_float(document.getElementById('aporte_mensal').value),
            primeiro_mov_mes2: document.getElementById('primeiro_mov_mes2').checked,
            corrigir_mov: document.getElementById('corrigir_mov').checked,
            parar_quando_acabar: document.getElementById('parar_quando_acabar').checked,
        };
        return inputs;
    }

    function displayResumo(resumo) {
        const container = document.getElementById('resumoContainer');
        let items = [], title = 'Resumo da Simulação';
        
        if (resumo.hasOwnProperty('saldo_liquido_nominal')) { // Modos 'aportes' ou 'nenhum'
             items.push(
                { Item: "Saldo Líquido Final Nominal (R$)", Valor: fmt_money(resumo.saldo_liquido_nominal) },
                { Item: "Saldo Líquido Final Real (R$ de hoje)", Valor: fmt_money(resumo.saldo_liquido_real) }
             );
             if (resumo.total_aportes_nominal > 0) {
                items.push({ Item: "Total Aportes Nominais (R$)", Valor: fmt_money(resumo.total_aportes_nominal) });
             }
             if (resumo.ir_cc_total > 0) items.push({ Item: "IR Come-Cotas (antecipado) (R$)", Valor: fmt_money(resumo.ir_cc_total) });
             items.push({ Item: "IR Final / Ajuste (R$)", Valor: fmt_money(resumo.ir_final_nominal) });

        } else { // Modo 'saques'
             items.push(
                { Item: "Saldo Final Nominal (R$)", Valor: fmt_money(resumo.saldo_final_nominal) },
                { Item: "Saldo Final Real (R$ de hoje)", Valor: fmt_money(resumo.saldo_final_real) },
                { Item: "Total Saques Brutos Nominais (R$)", Valor: fmt_money(resumo.total_saques_nominal) }
             );
            if (resumo.ir_cc_total > 0) items.push({ Item: "Total IR Come-Cotas (R$)", Valor: fmt_money(resumo.ir_cc_total) });
            if (resumo.total_ir_saque > 0) items.push({ Item: "Total IR sobre Saques (R$)", Valor: fmt_money(resumo.total_ir_saque) });
        }
        
        items.push({ Item: "Total Taxas (Adm/Custódia) (R$)", Valor: fmt_money(resumo.total_taxa_nominal) });
        items.push({ Item: "Períodos executados", Valor: resumo.periodos_executados });

        let tableHTML = `<h3 class="text-xl font-semibold mb-4 text-gray-800">${title}</h3>
                         <div class="overflow-x-auto border rounded-lg"><table class="min-w-full bg-white">
                         <thead class="bg-gray-50"><tr><th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th><th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th></tr></thead>
                         <tbody class="divide-y divide-gray-200">`;
        items.forEach(item => { tableHTML += `<tr><td class="py-4 px-6 whitespace-nowrap text-sm font-medium text-gray-900">${item.Item}</td><td class="py-4 px-6 whitespace-nowrap text-sm text-gray-500">${item.Valor}</td></tr>`; });
        tableHTML += '</tbody></table></div>';
        container.innerHTML = tableHTML;
    }

    function displayPlanilha(df, inputs, mode = 'nominal') {
        const container = document.getElementById('planilhaContainer');
        const { modo_movimentacao, tipo_taxa } = inputs;

        const taxaHeader = tipo_taxa === 'custodia' ? 'Taxa Custódia' : 'Taxa Adm.';
        
        let headers = ["Mês", "Saldo Inicial", "Rendimento", taxaHeader, "IR C.Cotas"];
        let keys = ["Mes", "A_Saldo_Inicial_Nominal", "B_Rendimento_Nominal", "D_Taxa_Nominal", "F_IR_Come_Cotas_Nominal"];

        if (modo_movimentacao === 'saques') {
            headers.push("Saque Bruto", "Alíq. IR (%)", "IR Saque");
            keys.push("Saque_Bruto_Nominal", "Aliquota_IR_pct", "IR_Saque_Nominal");
        } else if (modo_movimentacao === 'aportes') {
            headers.push("Aporte");
            keys.push("Aporte_Nominal");
        }
        headers.push("Saldo Final");
        keys.push("H_Saldo_Final_Nominal");

        const suffix = mode === 'real' ? '_Real' : '_Nominal';
        const finalKeys = keys.map(k => k.includes('Aliquota') || k === 'Mes' ? k : k.replace('_Nominal', suffix));
        
        let tableHTML = '<table><thead><tr>';
        headers.forEach(h => tableHTML += `<th>${h}</th>`);
        tableHTML += '</tr></thead><tbody>';

        df.forEach(row => {
            tableHTML += '<tr>';
            finalKeys.forEach(key => {
                const val = row[key];
                let formattedVal = '';
                if (key === 'Mes') {
                    formattedVal = val;
                } else if (key.includes('Aliquota')) {
                    formattedVal = val > 0 ? fmt_pct(val) : '-';
                } else if (typeof val === 'number') {
                    formattedVal = fmt_money(val);
                }
                tableHTML += `<td>${formattedVal}</td>`;
            });
            tableHTML += '</tr>';
        });
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }

    function displayChart(df, mode = 'nominal') {
        const ctx = document.getElementById('saldoChart').getContext('2d');
        document.getElementById('chartTitle').textContent = `Evolução do Saldo (${mode === 'real' ? 'Real' : 'Nominal'})`;
        
        const suffix = mode === 'real' ? '_Real' : '_Nominal';
        const key = `H_Saldo_Final${suffix}`;

        const labels = df.map(row => row.Mes);
        const data = df.map(row => round2(row[key]));

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Saldo Final (${mode})`,
                    data: data,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { ticks: { callback: (value) => 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 0}) } } }
            }
        });
    }

    function convertToCSV(data) {
        if (!data || data.length === 0) return '';
        const headers = Object.keys(data[0]);
        const headerRow = headers.join(';');
        const rows = data.map(row => {
            return headers.map(header => String(row[header]).replace('.', ',')).join(';');
        });
        return [headerRow, ...rows].join('\n');
    }

    // INICIALIZAÇÃO DA UI
    toggleInvestimento();
    toggleTipoTaxa();
    toggleIrModo();
    toggleMovimentacao();
    toggleInflacaoZero();
    updateTaxaNominalDisplay();

</script>

</body>
</html>