<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Avançado: Tesouro IPCA+ vs Fundos (Nominal vs Real)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .form-input { width: 100%; padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db; background-color: #ffffff; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .form-input:disabled { background-color: #f3f4f6; cursor: not-allowed; }
        .btn { padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-weight: 600; color: white; transition: background-color 0.2s; cursor: pointer; border: none; }
        .btn-primary { background-color: #3b82f6; }
        .btn-primary:hover { background-color: #2563eb; }
        .table-container { max-height: 500px; overflow: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        thead th { background-color: #f9fafb; position: sticky; top: 0; z-index: 10; }
        tbody tr:nth-child(even) { background-color: #f9fafb; }
        /* Toggle Switch Styles */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body class="antialiased text-gray-800 p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Simulador Avançado de Investimentos</h1>
            <p class="text-gray-600 mt-2">Compare Tesouro IPCA+ e Fundos com análise de valores Nominais e Reais.</p>
        </header>

        <form id="simuladorForm">
            <div class="mb-6">
                <label class="block text-lg font-semibold mb-3 text-gray-700">1. Tipo de Investimento</label>
                <div class="flex flex-col sm:flex-row gap-4">
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition-all">
                        <input type="radio" id="tipoTesouro" name="tipo_investimento" value="tesouro" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                        <span class="ml-3 text-gray-800">Tesouro IPCA+</span>
                    </label>
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition-all">
                        <input type="radio" id="tipoComeCotas" name="tipo_investimento" value="comecotas" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <span class="ml-3 text-gray-800">Fundo IPCA+ com Come-Cotas</span>
                    </label>
                </div>
            </div>

            <hr class="my-6">

            <div>
                 <label class="block text-lg font-semibold mb-3 text-gray-700">2. Parâmetros da Simulação</label>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label for="saldo_inicial" class="block text-sm font-medium text-gray-700 mb-1">Saldo inicial (R$)</label>
                        <input type="text" id="saldo_inicial" class="form-input" value="1.000.000,00">
                    </div>
                    <div>
                        <label for="meses" class="block text-sm font-medium text-gray-700 mb-1">Meses de projeção</label>
                        <input type="text" id="meses" class="form-input" value="240">
                    </div>
                    <div>
                        <label for="ipca" class="block text-sm font-medium text-gray-700 mb-1">Inflação (IPCA) % a.a.</label>
                        <input type="text" id="ipca" class="form-input" value="3,500">
                    </div>
                    <div>
                        <label for="real" class="block text-sm font-medium text-gray-700 mb-1">Juros Reais % a.a.</label>
                        <input type="text" id="real" class="form-input" value="5,500">
                    </div>
                </div>
                 <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="inflacao_zero" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700 font-medium">Calcular com inflação zero</span>
                    </label>
                 </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                 <div id="custodiaContainer">
                    <label for="custodia" class="block text-sm font-medium text-gray-700 mb-1">Taxa de Custódia % a.a. (B3)</label>
                    <input type="text" id="custodia" class="form-input" value="0,200">
                </div>
                 <div id="admContainer" class="hidden">
                    <label for="taxa_adm_aa" class="block text-sm font-medium text-gray-700 mb-1">Taxa de Administração % a.a.</label>
                    <input type="text" id="taxa_adm_aa" class="form-input" value="1,000">
                </div>
                 <div id="tipoFundoContainer" class="hidden">
                    <label for="tipo_fundo" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Fundo (Come-Cotas)</label>
                    <select id="tipo_fundo" class="form-input">
                        <option value="longo">Longo Prazo (Alíquota 15%)</option>
                        <option value="curto">Curto Prazo (Alíquota 20%)</option>
                    </select>
                </div>
                <div id="tesouroIrContainer">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                            <label for="tesouro_ir_modo" class="block text-sm font-medium text-gray-700 mb-1">Modo de IR (Tesouro)</label>
                            <select id="tesouro_ir_modo" class="form-input">
                                <option value="regressiva">Tabela Regressiva</option>
                                <option value="fixa">Alíquota Fixa</option>
                            </select>
                        </div>
                        <div id="tesouro_aliquota_fixa_container" class="hidden">
                            <label for="tesouro_aliquota_fixa" class="block text-sm font-medium text-gray-700 mb-1">Alíquota Fixa (%)</label>
                            <input type="text" id="tesouro_aliquota_fixa" class="form-input" value="15,000">
                        </div>
                    </div>
                </div>
            </div>
            
            <hr class="my-6">

            <div>
                <label class="block text-lg font-semibold mb-3 text-gray-700">3. Saques Mensais</label>
                <div class="mb-6 flex flex-col sm:flex-row gap-4">
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition-all">
                        <input type="radio" id="modoSaques" name="modo" value="saques" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                        <span class="ml-3 text-gray-800">Ativar saques mensais</span>
                    </label>
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer flex-1 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition-all">
                        <input type="radio" id="modoUnico" name="modo" value="unico" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <span class="ml-3 text-gray-800">Sem saques (resgate único)</span>
                    </label>
                </div>

                <div id="saquesContainer" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="saque_inicial" class="block text-sm font-medium text-gray-700 mb-1">Saque mensal inicial (R$)</label>
                        <input type="text" id="saque_inicial" class="form-input" value="6.000,00">
                    </div>
                    <div class="col-span-1 md:col-span-2 flex flex-col sm:flex-row sm:items-center gap-4 sm:pt-6">
                        <label class="flex items-center">
                            <input type="checkbox" id="primeiro_saque_mes2" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                            <span class="ml-2 text-sm text-gray-700">1º saque no mês 2</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="corrigir_saque" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                            <span class="ml-2 text-sm text-gray-700">Corrigir saque pela inflação</span>
                        </label>
                         <label class="flex items-center">
                            <input type="checkbox" id="parar_quando_acabar" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                            <span class="ml-2 text-sm text-gray-700">Parar quando saldo acabar</span>
                        </label>
                    </div>
                </div>
            </div>

            <button type="submit" id="executarBtn" class="btn btn-primary w-full text-lg mt-8">
                Executar simulação
            </button>
            <div id="error-message" class="mt-4 text-center text-red-600 font-medium"></div>
        </form>

        <div id="results" class="mt-10 hidden">
            <div id="resumoContainer" class="mb-8"></div>
            
             <div class="my-6 p-4 bg-gray-100 rounded-lg flex flex-col sm:flex-row justify-center items-center gap-4 sm:gap-8">
                <div class="flex items-center gap-3">
                    <span class="font-medium text-gray-700">Ver Valores Nominais</span>
                    <label class="switch">
                        <input type="checkbox" id="viewToggle">
                        <span class="slider"></span>
                    </label>
                    <span class="font-medium text-gray-700">Ver Valores Reais</span>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-8">
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-800" id="planilhaTitle">Planilha de Evolução</h3>
                    <div id="planilhaContainer" class="table-container"></div>
                    <button id="downloadCsv" class="btn btn-primary mt-4">Baixar CSV</button>
                </div>
                <div>
                     <h3 class="text-xl font-semibold mb-4 text-gray-800" id="chartTitle">Evolução do Saldo</h3>
                    <div class="p-4 border rounded-lg bg-white">
                        <canvas id="saldoChart" style="min-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- LÓGICA DA UI ---
    const form = document.getElementById('simuladorForm');
    const tipoInvestimentoRadios = document.querySelectorAll('input[name="tipo_investimento"]');
    const modoRadios = document.querySelectorAll('input[name="modo"]');
    
    const custodiaContainer = document.getElementById('custodiaContainer');
    const admContainer = document.getElementById('admContainer');
    const tipoFundoContainer = document.getElementById('tipoFundoContainer');
    const saquesContainer = document.getElementById('saquesContainer');
    
    const tesouroIrContainer = document.getElementById('tesouroIrContainer');
    const tesouroIrModoSelect = document.getElementById('tesouro_ir_modo');
    const tesouroAliquotaFixaContainer = document.getElementById('tesouro_aliquota_fixa_container');

    const inflacaoZeroCheckbox = document.getElementById('inflacao_zero');
    const ipcaInput = document.getElementById('ipca');
    const resultsDiv = document.getElementById('results');
    const downloadBtn = document.getElementById('downloadCsv');
    const viewToggle = document.getElementById('viewToggle');
    
    let chartInstance = null;
    let fullData = [];

    function toggleInvestimento() {
        if (document.getElementById('tipoTesouro').checked) {
            custodiaContainer.style.display = 'block';
            tesouroIrContainer.style.display = 'block';
            admContainer.style.display = 'none';
            tipoFundoContainer.style.display = 'none';
        } else {
            custodiaContainer.style.display = 'none';
            tesouroIrContainer.style.display = 'none';
            admContainer.style.display = 'block';
            tipoFundoContainer.style.display = 'block';
        }
    }

    function toggleModoSaques() {
        saquesContainer.style.display = document.getElementById('modoSaques').checked ? 'grid' : 'none';
    }

    function toggleInflacaoZero() {
        if (inflacaoZeroCheckbox.checked) {
            ipcaInput.value = '0,000';
            ipcaInput.disabled = true;
        } else {
            ipcaInput.disabled = false;
        }
    }
    
    function toggleTesouroIrModo() {
        tesouroAliquotaFixaContainer.style.display = tesouroIrModoSelect.value === 'fixa' ? 'block' : 'none';
    }

    tipoInvestimentoRadios.forEach(radio => radio.addEventListener('change', toggleInvestimento));
    modoRadios.forEach(radio => radio.addEventListener('change', toggleModoSaques));
    inflacaoZeroCheckbox.addEventListener('change', toggleInflacaoZero);
    tesouroIrModoSelect.addEventListener('change', toggleTesouroIrModo);
    viewToggle.addEventListener('change', () => {
        const displayMode = viewToggle.checked ? 'real' : 'nominal';
        displayPlanilha(fullData, displayMode);
        displayChart(fullData, displayMode);
    });

    downloadBtn.addEventListener('click', () => {
        const csvData = convertToCSV(fullData);
        const blob = new Blob([`\uFEFF${csvData}`], { type: 'text/csv;charset=utf-8-sig;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', 'simulacao_investimento.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        document.getElementById('error-message').textContent = '';
        resultsDiv.classList.add('hidden');

        try {
            const inputs = getInputs();
            let df, resumo;
            
            if (inputs.tipo_investimento === 'tesouro') {
                 [df, resumo] = simular_tesouro(inputs);
            } else {
                 [df, resumo] = simular_fundo_come_cotas(inputs);
            }
            
            fullData = df;
            displayResumo(resumo, inputs);
            
            viewToggle.checked = false;
            displayPlanilha(df, 'nominal');
            displayChart(df, 'nominal');
            
            resultsDiv.classList.remove('hidden');

        } catch (error) {
            console.error(error);
            document.getElementById('error-message').textContent = `Erro: ${error.message}. Verifique os valores de entrada.`;
        }
    });

    // --- FUNÇÕES DE CÁLCULO ---
    const round2 = (x) => Math.round((x + Number.EPSILON) * 100) / 100;
    const fmt_money = (v) => v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const fmt_pct = (v) => v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '%';

    function ptbr_to_float(txt) {
        if (txt === null || txt === undefined) return 0.0;
        const s = String(txt).trim().replace(/\./g, '').replace(',', '.');
        const val = parseFloat(s);
        if (isNaN(val)) throw new Error(`Valor inválido: "${txt}"`);
        return val;
    }

    const taxa_mensal = (t_anual) => Math.pow(1 + t_anual, 1 / 12) - 1;
    const taxa_mensal_ipca_real = (ipca_aa, real_aa) => Math.pow((1 + ipca_aa) * (1 + real_aa), 1 / 12) - 1;

    function aliquota_regressiva_por_m(meses) {
        if (meses <= 6) return 0.225;
        if (meses <= 12) return 0.20;
        if (meses <= 24) return 0.175;
        return 0.15;
    }

    // --- FUNÇÕES DE SIMULAÇÃO ---
    function simular_tesouro(params) {
        const { modo, saldo_inicial, saque_inicial, meses_float, ipca_aa, real_aa, custodia_aa, primeiro_saque_mes2, corrigir_saque_pelo_ipca, parar_quando_acabar, tesouro_ir_modo, tesouro_aliquota_fixa } = params;
        
        const ipca_m = taxa_mensal(ipca_aa);
        const r_m = taxa_mensal_ipca_real(ipca_aa, real_aa);
        const r_cust = taxa_mensal(custodia_aa);
        
        let A_Nominal = saldo_inicial;
        let custo_proporcional_total = saldo_inicial;
        let linhas = [];
        let total_ir = 0.0, total_saques_brutos_nominal = 0.0, total_custodia_nominal = 0.0;
        let fator_inflacao_acumulada = 1.0;

        for (let m = 1; m <= meses_float; m++) {
            const fator_inflacao_anterior = fator_inflacao_acumulada;
            fator_inflacao_acumulada *= (1 + ipca_m);

            const B_Rendimento_Nominal = A_Nominal * r_m;
            const C_Apos_Rend_Nominal = A_Nominal + B_Rendimento_Nominal;
            const Taxa_Custodia_Nominal = C_Apos_Rend_Nominal * r_cust;
            const D_Apos_Custodia_Nominal = C_Apos_Rend_Nominal - Taxa_Custodia_Nominal;
            total_custodia_nominal += Taxa_Custodia_Nominal;

            let E_Saque_Bruto_Nominal = 0.0, G_IR_Saque_Nominal = 0.0, Aliquota_IR_pct = 0.0;

            if (modo === 'saques') {
                if (primeiro_saque_mes2 ? m > 1 : true) {
                    const fator_correcao_saque = corrigir_saque_pelo_ipca ? Math.pow(1 + ipca_m, (primeiro_saque_mes2 ? m - 2 : m - 1)) : 1;
                    E_Saque_Bruto_Nominal = saque_inicial * fator_correcao_saque;
                }
                E_Saque_Bruto_Nominal = Math.min(E_Saque_Bruto_Nominal, Math.max(0.0, D_Apos_Custodia_Nominal));
                
                if (E_Saque_Bruto_Nominal > 0) {
                    const prop_saque = D_Apos_Custodia_Nominal > 0 ? (E_Saque_Bruto_Nominal / D_Apos_Custodia_Nominal) : 0;
                    const Custo_Proporcional_Saque = custo_proporcional_total * prop_saque;
                    const F_Rendimento_no_Saque_Nominal = Math.max(0.0, E_Saque_Bruto_Nominal - Custo_Proporcional_Saque);
                    
                    const aliq_saque = tesouro_ir_modo === 'regressiva' ? aliquota_regressiva_por_m(m) : tesouro_aliquota_fixa;
                    Aliquota_IR_pct = aliq_saque * 100.0;

                    G_IR_Saque_Nominal = F_Rendimento_no_Saque_Nominal * aliq_saque;
                    total_ir += G_IR_Saque_Nominal;
                    
                    custo_proporcional_total -= Custo_Proporcional_Saque;
                    total_saques_brutos_nominal += E_Saque_Bruto_Nominal;
                }
            }
            
            const H_Saldo_Final_Nominal = D_Apos_Custodia_Nominal - E_Saque_Bruto_Nominal;

            linhas.push({
                Mes: m,
                A_Saldo_Inicial_Nominal: A_Nominal,
                B_Rendimento_Nominal, Taxa_Custodia_Nominal, E_Saque_Bruto_Nominal, Aliquota_IR_pct, G_IR_Saque_Nominal, H_Saldo_Final_Nominal,
                A_Saldo_Inicial_Real: A_Nominal / fator_inflacao_anterior,
                B_Rendimento_Real: B_Rendimento_Nominal / fator_inflacao_acumulada,
                Taxa_Custodia_Real: Taxa_Custodia_Nominal / fator_inflacao_acumulada,
                E_Saque_Bruto_Real: E_Saque_Bruto_Nominal / fator_inflacao_acumulada,
                G_IR_Saque_Real: G_IR_Saque_Nominal / fator_inflacao_acumulada,
                H_Saldo_Final_Real: H_Saldo_Final_Nominal / fator_inflacao_acumulada
            });
            
            A_Nominal = H_Saldo_Final_Nominal;
            if (parar_quando_acabar && modo === 'saques' && A_Nominal <= 1.0) break;
        }

        let resumo = {
            saldo_final_nominal: A_Nominal,
            saldo_final_real: A_Nominal / fator_inflacao_acumulada,
            total_saques_brutos_nominal,
            total_saques_brutos_real: total_saques_brutos_nominal / fator_inflacao_acumulada,
            total_ir,
            total_custodia_nominal,
            periodos_executados: linhas.length
        };

        if (modo === 'unico') {
             const lucro_total_nominal = Math.max(0.0, A_Nominal - saldo_inicial);
             const aliq_final = tesouro_ir_modo === 'regressiva' ? aliquota_regressiva_por_m(meses_float) : tesouro_aliquota_fixa;
             resumo.ir_final_nominal = lucro_total_nominal * aliq_final;
             resumo.saldo_liquido_nominal = A_Nominal - resumo.ir_final_nominal;
             resumo.saldo_liquido_real = resumo.saldo_liquido_nominal / fator_inflacao_acumulada;
        }

        return [linhas, resumo];
    }
    
    function simular_fundo_come_cotas(params) {
        const { modo, saldo_inicial, saque_inicial, meses_float, ipca_aa, real_aa, taxa_adm_aa, tipo_fundo, primeiro_saque_mes2, corrigir_saque_pelo_ipca, parar_quando_acabar } = params;

        const ipca_m = taxa_mensal(ipca_aa);
        const r_m = taxa_mensal_ipca_real(ipca_aa, real_aa);
        const taxa_adm_m = taxa_mensal(taxa_adm_aa);
        const aliquota_cc = tipo_fundo === 'longo' ? 0.15 : 0.20;

        let A_Nominal = saldo_inicial;
        let linhas = [];
        let rendimento_acum_cc = 0.0;
        let fator_inflacao_acumulada = 1.0;
        let total_ir_cc = 0.0, total_ir_saque = 0.0, total_taxa_adm = 0.0, total_saques_brutos_nominal = 0.0;
        let custo_proporcional_total = saldo_inicial;

        for (let m = 1; m <= meses_float; m++) {
            const fator_inflacao_anterior = fator_inflacao_acumulada;
            fator_inflacao_acumulada *= (1 + ipca_m);

            const B_Rend_Bruto_Nominal = A_Nominal * r_m;
            const C_Apos_Rend_Nominal = A_Nominal + B_Rend_Bruto_Nominal;
            const D_Taxa_Adm_Nominal = C_Apos_Rend_Nominal * taxa_adm_m;
            const E_Apos_Taxas_Nominal = C_Apos_Rend_Nominal - D_Taxa_Adm_Nominal;
            
            const rendimento_liquido_mes = B_Rend_Bruto_Nominal - D_Taxa_Adm_Nominal;
            rendimento_acum_cc += rendimento_liquido_mes;
            total_taxa_adm += D_Taxa_Adm_Nominal;
            
            let F_IR_Come_Cotas_Nominal = 0.0;
            const mes_calendario = (m % 12 === 0) ? 12 : m % 12;
            if (mes_calendario === 5 || mes_calendario === 11) {
                if (rendimento_acum_cc > 0) {
                    F_IR_Come_Cotas_Nominal = rendimento_acum_cc * aliquota_cc;
                    total_ir_cc += F_IR_Come_Cotas_Nominal;
                    rendimento_acum_cc = 0;
                }
            }
            
            const G_Apos_CC_Nominal = E_Apos_Taxas_Nominal - F_IR_Come_Cotas_Nominal;
            
            let H_Saque_Bruto_Nominal = 0.0, I_IR_Saque_Nominal = 0.0, Aliquota_IR_Saque_pct = 0.0;

            if (modo === 'saques') {
                 if (primeiro_saque_mes2 ? m > 1 : true) {
                    const fator_correcao_saque = corrigir_saque_pelo_ipca ? Math.pow(1 + ipca_m, (primeiro_saque_mes2 ? m - 2 : m - 1)) : 1;
                    H_Saque_Bruto_Nominal = saque_inicial * fator_correcao_saque;
                }
                H_Saque_Bruto_Nominal = Math.min(H_Saque_Bruto_Nominal, Math.max(0.0, G_Apos_CC_Nominal));
                
                if (H_Saque_Bruto_Nominal > 0) {
                    const prop_saque = G_Apos_CC_Nominal > 0 ? (H_Saque_Bruto_Nominal / G_Apos_CC_Nominal) : 0;
                    const Custo_Proporcional_Saque = custo_proporcional_total * prop_saque;
                    const Rendimento_no_Saque_Nominal = Math.max(0.0, H_Saque_Bruto_Nominal - Custo_Proporcional_Saque);
                    
                    // ALTERAÇÃO: Calcula e armazena a alíquota do saque
                    const aliq_saque = aliquota_regressiva_por_m(m);
                    Aliquota_IR_Saque_pct = aliq_saque * 100.0;
                    I_IR_Saque_Nominal = Rendimento_no_Saque_Nominal * aliq_saque;
                    total_ir_saque += I_IR_Saque_Nominal;

                    custo_proporcional_total -= Custo_Proporcional_Saque;
                    custo_proporcional_total -= (F_IR_Come_Cotas_Nominal * (1-prop_saque));
                    total_saques_brutos_nominal += H_Saque_Bruto_Nominal;
                }
            }
            
            const J_Saldo_Final_Nominal = G_Apos_CC_Nominal - H_Saque_Bruto_Nominal;

            linhas.push({
                Mes: m,
                A_Saldo_Inicial_Nominal: A_Nominal,
                B_Rend_Bruto_Nominal, D_Taxa_Adm_Nominal, F_IR_Come_Cotas_Nominal, H_Saque_Bruto_Nominal, Aliquota_IR_Saque_pct, I_IR_Saque_Nominal, J_Saldo_Final_Nominal, // ALTERAÇÃO: Adiciona Aliquota_IR_Saque_pct
                A_Saldo_Inicial_Real: A_Nominal / fator_inflacao_anterior,
                B_Rend_Bruto_Real: B_Rend_Bruto_Nominal / fator_inflacao_acumulada,
                D_Taxa_Adm_Real: D_Taxa_Adm_Nominal / fator_inflacao_acumulada,
                F_IR_Come_Cotas_Real: F_IR_Come_Cotas_Nominal / fator_inflacao_acumulada,
                H_Saque_Bruto_Real: H_Saque_Bruto_Nominal / fator_inflacao_acumulada,
                I_IR_Saque_Real: I_IR_Saque_Nominal / fator_inflacao_acumulada,
                J_Saldo_Final_Real: J_Saldo_Final_Nominal / fator_inflacao_acumulada
            });

            A_Nominal = J_Saldo_Final_Nominal;
            if (parar_quando_acabar && modo === 'saques' && A_Nominal <= 1.0) break;
        }

        let resumo = {
            saldo_final_nominal: A_Nominal,
            saldo_final_real: A_Nominal / fator_inflacao_acumulada,
            total_saques_brutos_nominal,
            total_saques_brutos_real: total_saques_brutos_nominal / fator_inflacao_acumulada,
            total_ir_cc,
            total_ir_saque,
            total_taxa_adm,
            periodos_executados: linhas.length
        };
        
        if (modo === 'unico') {
            const lucro_total_bruto = A_Nominal + total_taxa_adm - saldo_inicial;
            const ir_total_devido = (lucro_total_bruto - total_taxa_adm) * aliquota_regressiva_por_m(meses_float);
            resumo.ir_ajuste_final_nominal = Math.max(0, ir_total_devido - total_ir_cc);
            resumo.saldo_liquido_nominal = A_Nominal - resumo.ir_ajuste_final_nominal;
            resumo.saldo_liquido_real = resumo.saldo_liquido_nominal / fator_inflacao_acumulada;
        }

        return [linhas, resumo];
    }

    // --- FUNÇÕES DE DISPLAY ---
    function getInputs() {
        const tipo_investimento = document.querySelector('input[name="tipo_investimento"]:checked').value;
        const inputs = {
            tipo_investimento,
            modo: document.querySelector('input[name="modo"]:checked').value,
            saldo_inicial: ptbr_to_float(document.getElementById('saldo_inicial').value),
            meses_float: ptbr_to_float(document.getElementById('meses').value),
            ipca_aa: ptbr_to_float(document.getElementById('ipca').value) / 100.0,
            real_aa: ptbr_to_float(document.getElementById('real').value) / 100.0,
            saque_inicial: ptbr_to_float(document.getElementById('saque_inicial').value),
            primeiro_saque_mes2: document.getElementById('primeiro_saque_mes2').checked,
            corrigir_saque_pelo_ipca: document.getElementById('corrigir_saque').checked,
            parar_quando_acabar: document.getElementById('parar_quando_acabar').checked,
        };

        if (tipo_investimento === 'tesouro') {
            inputs.custodia_aa = ptbr_to_float(document.getElementById('custodia').value) / 100.0;
            inputs.tesouro_ir_modo = document.getElementById('tesouro_ir_modo').value;
            inputs.tesouro_aliquota_fixa = ptbr_to_float(document.getElementById('tesouro_aliquota_fixa').value) / 100.0;
        } else {
            inputs.taxa_adm_aa = ptbr_to_float(document.getElementById('taxa_adm_aa').value) / 100.0;
            inputs.tipo_fundo = document.getElementById('tipo_fundo').value;
        }
        return inputs;
    }

    function displayResumo(resumo, inputs) {
        const container = document.getElementById('resumoContainer');
        let items = [], title = '';
        const { tipo_investimento, modo } = inputs;
        
        title = tipo_investimento === 'tesouro' ? 'Resumo Tesouro IPCA+' : 'Resumo Fundo IPCA+';
        title += modo === 'saques' ? ' (com Saques)' : ' (Resgate Único)';
        
        if (modo === 'saques') {
             items = [
                { Item: "Saldo Final Nominal (R$)", Valor: fmt_money(resumo.saldo_final_nominal) },
                { Item: "Saldo Final Real (R$ de hoje)", Valor: fmt_money(resumo.saldo_final_real) },
                { Item: "Total Saques Brutos Nominais (R$)", Valor: fmt_money(resumo.total_saques_brutos_nominal) },
             ];
             if (tipo_investimento === 'tesouro') {
                 items.push({ Item: "Total IR sobre Saques (R$)", Valor: fmt_money(resumo.total_ir) });
                 items.push({ Item: "Total Taxa de Custódia (R$)", Valor: fmt_money(resumo.total_custodia_nominal) });
             } else {
                 items.push({ Item: "Total IR Come-Cotas (R$)", Valor: fmt_money(resumo.total_ir_cc) });
                 items.push({ Item: "Total IR sobre Saques (R$)", Valor: fmt_money(resumo.total_ir_saque) });
                 items.push({ Item: "Total Taxa de Admin. (R$)", Valor: fmt_money(resumo.total_taxa_adm) });
             }
        } else { // Resgate Único
            items = [
                { Item: "Valor Líquido Final Nominal (R$)", Valor: fmt_money(resumo.saldo_liquido_nominal) },
                { Item: "Valor Líquido Final Real (R$ de hoje)", Valor: fmt_money(resumo.saldo_liquido_real) },
            ];
            if (tipo_investimento === 'tesouro') {
                 items.push({ Item: "IR Final (R$)", Valor: fmt_money(resumo.ir_final_nominal) });
                 items.push({ Item: "Total Taxa de Custódia (R$)", Valor: fmt_money(resumo.total_custodia_nominal) });
             } else {
                 items.push({ Item: "IR Come-Cotas (antecipado) (R$)", Valor: fmt_money(resumo.total_ir_cc) });
                 items.push({ Item: "IR Ajuste Final no Resgate (R$)", Valor: fmt_money(resumo.ir_ajuste_final_nominal) });
                 items.push({ Item: "Total Taxa de Admin. (R$)", Valor: fmt_money(resumo.total_taxa_adm) });
             }
        }
        
        items.push({ Item: "Períodos executados", Valor: resumo.periodos_executados });

        let tableHTML = `<h3 class="text-xl font-semibold mb-4 text-gray-800">${title}</h3>
                         <div class="overflow-x-auto border rounded-lg"><table class="min-w-full bg-white">
                         <thead class="bg-gray-50"><tr><th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th><th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th></tr></thead>
                         <tbody class="divide-y divide-gray-200">`;
        items.forEach(item => { tableHTML += `<tr><td class="py-4 px-6 whitespace-nowrap text-sm font-medium text-gray-900">${item.Item}</td><td class="py-4 px-6 whitespace-nowrap text-sm text-gray-500">${item.Valor}</td></tr>`; });
        tableHTML += '</tbody></table></div>';
        container.innerHTML = tableHTML;
    }

    function displayPlanilha(df, mode = 'nominal') {
        const container = document.getElementById('planilhaContainer');
        const isTesouro = df[0].hasOwnProperty('Taxa_Custodia_Nominal');
        const isSaques = df[0].hasOwnProperty('E_Saque_Bruto_Nominal') || df[0].hasOwnProperty('H_Saque_Bruto_Nominal');
        
        let headers = [], keys = [];
        const suffix = mode === 'real' ? '_Real' : '_Nominal';

        if (isTesouro && isSaques) {
            headers = ["Mês", "Saldo Inicial", "Rendimento", "Taxa Custódia", "Saque Bruto", "Alíquota IR (%)", "IR Saque", "Saldo Final"];
            keys = ["Mes", `A_Saldo_Inicial${suffix}`, `B_Rendimento${suffix}`, `Taxa_Custodia${suffix}`, `E_Saque_Bruto${suffix}`, "Aliquota_IR_pct", `G_IR_Saque${suffix}`, `H_Saldo_Final${suffix}`];
        } else if (!isTesouro && isSaques) {
            // ALTERAÇÃO: Adiciona a nova coluna de alíquota para o Fundo
            headers = ["Mês", "Saldo Inicial", "Rend. Bruto", "Taxa Adm.", "IR Come-Cotas", "Saque Bruto", "Alíq. IR Saque (%)", "IR Saque", "Saldo Final"];
            keys = ["Mes", `A_Saldo_Inicial${suffix}`, `B_Rend_Bruto${suffix}`, `D_Taxa_Adm${suffix}`, `F_IR_Come_Cotas${suffix}`, `H_Saque_Bruto${suffix}`, "Aliquota_IR_Saque_pct", `I_IR_Saque${suffix}`, `J_Saldo_Final${suffix}`];
        } else { // Resgate único
            headers = ["Mês", "Saldo Inicial", "Rendimento", "Taxa", "Saldo Final"];
            keys = isTesouro ? ["Mes", `A_Saldo_Inicial${suffix}`, `B_Rendimento${suffix}`, `Taxa_Custodia${suffix}`, `H_Saldo_Final${suffix}`]
                             : ["Mes", `A_Saldo_Inicial${suffix}`, `B_Rend_Bruto${suffix}`, `D_Taxa_Adm${suffix}`, `J_Saldo_Final${suffix}`];
        }
        
        let tableHTML = '<table><thead><tr>';
        headers.forEach(h => tableHTML += `<th>${h}</th>`);
        tableHTML += '</tr></thead><tbody>';

        df.forEach(row => {
            tableHTML += '<tr>';
            keys.forEach(key => {
                const val = row[key];
                let formattedVal = '';
                if (key === 'Mes') {
                    formattedVal = val;
                // ALTERAÇÃO: Unifica a formatação de porcentagem
                } else if (key.includes('Aliquota_IR')) {
                    formattedVal = val > 0 ? fmt_pct(val) : '-';
                } else if (typeof val === 'number') {
                    formattedVal = fmt_money(val);
                }
                tableHTML += `<td>${formattedVal}</td>`;
            });
            tableHTML += '</tr>';
        });
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }

    function displayChart(df, mode = 'nominal') {
        const ctx = document.getElementById('saldoChart').getContext('2d');
        document.getElementById('chartTitle').textContent = `Evolução do Saldo (${mode === 'real' ? 'Real' : 'Nominal'})`;
        
        const suffix = mode === 'real' ? '_Real' : '_Nominal';
        const key = df[0].hasOwnProperty('J_Saldo_Final_Nominal') ? `J_Saldo_Final${suffix}` : `H_Saldo_Final${suffix}`;

        const labels = df.map(row => row.Mes);
        const data = df.map(row => round2(row[key]));

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Saldo Final (${mode})`,
                    data: data,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { ticks: { callback: (value) => 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 0}) } } }
            }
        });
    }

    function convertToCSV(data) {
        if (!data || data.length === 0) return '';
        const headers = Object.keys(data[0]);
        const headerRow = headers.join(';');
        const rows = data.map(row => {
            return headers.map(header => String(row[header]).replace('.', ',')).join(';');
        });
        return [headerRow, ...rows].join('\n');
    }

    // INICIALIZAÇÃO DA UI
    toggleInvestimento();
    toggleModoSaques();
    toggleInflacaoZero();
    toggleTesouroIrModo();

</script>

</body>
</html>